module View exposing (view)

import Browser exposing (Document)
import Html exposing (Html, h1,  h3, h4, button, text,
    textarea, span, div, input, ol, ul, li, b)
import Html.Attributes exposing (class, value, name, id, type_,
    placeholder)
import Html.Events exposing (onClick, onInput, onFocus, onBlur)
import Json.Decode as Decode
import String

import AutoDropdown

import CloseCircle exposing (closeCircle)
import Country exposing (Country)
import Model exposing (..)
import Msg exposing (Msg(..))
import OnKeyDown exposing (onKeyDown)
import SearchLine exposing (searchLine)

{- This is the configuration for the dropdown
-}
dropdownConfig: AutoDropdown.Config Msg
dropdownConfig =
    { mouseDownMsg = ClickedSuggestion
    , mouseEnterMsg = MouseEnterSuggestion
    , ulAttrs = [ class "autodropdown-list" ]
    , liAttrs = [ class "autodropdown-item" ]
    , highlightedAttrs = [ class "autodropdown-item-highlighted" ]
    }

view : Model -> Document Msg
view model =
    { title = "AutoDropdown Example"
    , body = [
        render_content model,
        render_disclaimer
    ]
    }

render_content : Model -> Html Msg
render_content model =
    div [ class "main-container"] [
        div [] [
            h3 [] [ text "Enter the name of any country, in English" ]
        ],
        render_country_input model,
        if Array.length model.foundCountries == 0 then
            render_empty_country_data
        else
            render_countries_data model
    ]

render_country_input : Model -> Html Msg
render_country_input model =
    div [ class "text-input-field", id "input-container" ] [
        div [ class "search-input-wrapper" ] [
            render_search_text_input model,
            render_clear_icon_button model,
            render_search_icon_button model
        ],
        AutoDropdown.view dropdownConfig model.dropdownState model.suggestions
    ]


render_search_text_input : Model -> Html Msg
render_search_text_input model =
    let
        -- Style the text input differently depending on whether the dropdown
        -- is open or not.
        inputClass = if model.dropdownState.isOpen then "autodropdown-input-open" else ""
    in
        input [ type_ "text", class "autodropdown-input",
            placeholder "e.g., Thailand",
            value model.searchText,
            -- React when the text changes
            onInput UpdateSearchText,
            -- Look at every keystroke, to catch ENTER, ArrowUp, and ArrowDown
            onKeyDown KeyDownSearchText,
            -- The input looks slightly different when the dropdown is open
            class inputClass,
            -- When focus goes away, disable the dropdown too
            onBlur SearchInputBlurred,
            -- When focus arrives, bring back the the dropdown (if there are
            -- suggestions already)
            onFocus SearchInputFocused
            ]
        []

render_clear_icon_button : Model -> Html Msg
render_clear_icon_button model =
    if model.searchText == ""
    then text ""
    else
        button [id "clear-button",
            onClick ClickedClearIcon,
            class "clear-icon-btn" ] [
            CloseCircle.closeCircle []
        ]

render_search_icon_button : Model -> Html Msg
render_search_icon_button model =
    button [id "search-button",
        onClick ClickedSearchIcon,
        class "search-icon-btn" ] [
        SearchLine.searchLine []
    ]

render_disclaimer : Html Msg
render_disclaimer =
    div [] [
        h4 [] [text "Disclaimer"],
        div [ class "disclaimer" ] [
            text "This data is for example purposes only. Do not rely on it."
        ],
        div [ class "disclaimer" ] [
            text "This data was generated by the Qwen3-Max LLM on December 7, 2025."
        ],
        div [ class "disclaimer" ] [
            text "The LLM stated:"
        ],
        div [ class "disclaimer" ] [
            text """
[This is] the requested data for all 195 recognized sovereign states
(193 UN member states + 2 observer states: Vatican City and Palestine),
based on the latest reliable data as of mid-2024 to early 2025.
Population figures are approximate and sourced from the United Nations,
World Bank, and other reputable demographic sources.
"""
        ]
    ]


render_empty_country_data : Html Msg
render_empty_country_data =
    div [] [
        text "The results will appear here."
    ]

render_countries_data : Model -> Html Msg
render_countries_data model =
    div [] [
        ol [] (Array.map (\c -> render_country_data c model) model.foundCountries)
    ]

render_country_data : Country -> Model -> Html Msg
render_country_data country model =
    li [] [
        ul [] [
            li [] [
                text "Name: ",
                b [] [ text country.name ]
            ],
            li [] [
                text "Official Name: ",
                text country.officialName
            ],
            li [] [
                text "Population: ",
                -- This doesn't add commas, but to do so would require
                -- having localization libraries. This is just demo code, so
                -- I won't bother.
                text (String.fromInt country.population)
            ],
            li [] [
                text "Capital: ",
                text country.capital
            ]
        ]
    ]


